"use client"

import 'bootstrap-icons/font/bootstrap-icons.css';
import css from "@/styles/applications/leave/application.module.css"

import { useEffect, useState, useReducer, useMemo } from 'react';

import { toast } from 'react-toastify';

import ImgBlurLoad from '@/components/shared/img-blur-load';

import { SERVER_URL, WS_SERVER_URL } from '@/globals';

function forceDownload(blob, filename) {
    let a = document.createElement("a")
    a.download = filename
    a.href = blob
    a.target = "_blank"
    a.rel = "noreferrer"

    document.body.appendChild(a)
    a.click()
    a.remove()
}

export default function File({ info, setFileActionModal }) {

    const [ expanded, setExpanded ] = useState(false)

    function toggleExpand() {
        setExpanded(prev => prev = !prev)
    }

    function showImage() {
        if (!expanded) return <></>

        return (
            <p>Image</p>
        )
    }

    function download() {
        fetch(`${SERVER_URL}${info?.src}`, {
            headers: {
            },
            mode: "cors"
        })
        .then(res => res.blob())
        .then(blob => {
            let blobUrl = window.URL.createObjectURL(blob)
            forceDownload(blobUrl, info?.filename || "Без имени")
        })
        .catch(err => {
            toast.error("Не удалось скачать файл", {
                theme: "colored",
                autoClose: 10000
            })
        })
    }

    function showExpanded() {
        if (!expanded) return <></>

        return (
            <ImgBlurLoad src={info?.src ? SERVER_URL + info.src : ""} hash={info?.blur_hash} className={`${css["file-img"]}`} alt="Скан заявления"/>
        )
    }

    return (<>
        <div className={`${css["file"]}`}>
            <div className={`${css["file-info"]}`}>
                <a
                    href={`${SERVER_URL}${info?.src}`}
                    target="_blank"
                    rel="noreferrer"
                >{info?.filename || "Без имени"}</a>

                <div>
                    <button onClick={toggleExpand}>{expanded ? "Скрыть" : "Показать"}</button>
                    <button onClick={() => setFileActionModal({type: "DELETE", payload: info})}>
                        <svg width="15" height="16" viewBox="0 0 15 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10.6771 15.5002H4.32309C3.87626 15.5015 3.44507 15.3361 3.11379 15.0362C2.78254 14.7363 2.5751 14.3237 2.53208 13.8789L1.50307 3.55955C1.49459 3.47612 1.50372 3.39187 1.52987 3.31217C1.55603 3.23252 1.59862 3.15921 1.6549 3.09705C1.71118 3.0349 1.77989 2.98524 1.85658 2.95133C1.93326 2.91741 2.01622 2.89998 2.10007 2.90015H12.9001C12.9839 2.90015 13.0667 2.91772 13.1433 2.9517C13.2199 2.98569 13.2886 3.03534 13.3448 3.09746C13.4011 3.15958 13.4437 3.23279 13.4699 3.31238C13.4961 3.39197 13.5054 3.47615 13.4971 3.55955L12.4681 13.8784C12.4251 14.3232 12.2176 14.7359 11.8864 15.0358C11.5552 15.3358 11.1239 15.5013 10.6771 15.5002ZM2.76246 4.10014L3.72609 13.7596C3.74056 13.9078 3.80972 14.0453 3.9201 14.1452C4.03048 14.2452 4.17417 14.3004 4.32309 14.3001H10.6771C10.826 14.3004 10.9697 14.2452 11.08 14.1452C11.1904 14.0453 11.2596 13.9078 11.2741 13.7596L12.2377 4.10014H2.76246Z" fill="#007BFF"/>
                            <path d="M14.4 4.10014H0.600001C0.440869 4.10014 0.288259 4.03692 0.175737 3.9244C0.0632144 3.81188 0 3.65929 0 3.50014C0 3.34103 0.0632144 3.1884 0.175737 3.07588C0.288259 2.96336 0.440869 2.90015 0.600001 2.90015H14.4C14.5592 2.90015 14.7117 2.96336 14.8243 3.07588C14.9368 3.1884 15 3.34103 15 3.50014C15 3.65929 14.9368 3.81188 14.8243 3.9244C14.7117 4.03692 14.5592 4.10014 14.4 4.10014Z" fill="#007BFF"/>
                            <path d="M7.49941 13.0999C7.34026 13.0999 7.18767 13.0367 7.07515 12.9242C6.96262 12.8117 6.89941 12.6591 6.89941 12.4999V5.89992C6.89941 5.74081 6.96262 5.58818 7.07515 5.47566C7.18767 5.36314 7.34026 5.29993 7.49941 5.29993C7.65852 5.29993 7.81115 5.36314 7.92367 5.47566C8.03619 5.58818 8.0994 5.74081 8.0994 5.89992V12.4999C8.0994 12.6591 8.03619 12.8117 7.92367 12.9242C7.81115 13.0367 7.65852 13.0999 7.49941 13.0999Z" fill="#007BFF"/>
                            <path d="M5.39866 13.0999C5.249 13.0997 5.10477 13.0436 4.99432 12.9426C4.88383 12.8416 4.81515 12.7029 4.80166 12.5539L4.20166 5.95388C4.18732 5.79548 4.23646 5.63786 4.33828 5.51569C4.4401 5.39348 4.58627 5.31674 4.74467 5.30226C4.90317 5.28826 5.06076 5.33757 5.18296 5.43946C5.30521 5.54131 5.38211 5.68744 5.39686 5.84588L5.99686 12.4459C6.00437 12.5289 5.99448 12.6126 5.96783 12.6917C5.94116 12.7707 5.89834 12.8433 5.84202 12.9048C5.78574 12.9664 5.71723 13.0155 5.6409 13.0491C5.56457 13.0827 5.48206 13.1 5.39866 13.0999Z" fill="#007BFF"/>
                            <path d="M9.60063 13.0999C9.51723 13.1 9.43475 13.0827 9.35839 13.0491C9.28206 13.0156 9.21358 12.9664 9.15727 12.9049C9.10099 12.8434 9.05814 12.7707 9.03149 12.6917C9.00482 12.6127 8.99493 12.529 9.00244 12.4459L9.60243 5.84591C9.63305 5.51592 9.92104 5.27833 10.2547 5.30233C10.413 5.31677 10.5592 5.39354 10.661 5.51571C10.7628 5.63792 10.812 5.79551 10.7976 5.95391L10.1976 12.5539C10.1842 12.703 10.1155 12.8417 10.005 12.9427C9.89456 13.0437 9.75033 13.0998 9.60063 13.0999Z" fill="#007BFF"/>
                            <path d="M10.1992 4.1H4.79921C4.6401 4.1 4.48747 4.03679 4.37495 3.92427C4.26243 3.81175 4.19922 3.65912 4.19922 3.50001V1.1C4.19922 0.940869 4.26243 0.788259 4.37495 0.675737C4.48747 0.563214 4.6401 0.5 4.79921 0.5H10.1992C10.3583 0.5 10.511 0.563214 10.6235 0.675737C10.736 0.788259 10.7992 0.940869 10.7992 1.1V3.50001C10.7992 3.65912 10.736 3.81175 10.6235 3.92427C10.511 4.03679 10.3583 4.1 10.1992 4.1ZM5.39924 2.90001H9.59924V1.7H5.39924V2.90001Z" fill="#007BFF"/>
                        </svg>
                    </button>
                    <button onClick={download}>
                        <svg width="15" height="16" viewBox="0 0 15 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14.5312 10.8125C14.2725 10.8125 14.0625 11.0225 14.0625 11.2812V14.5625H0.937515V11.2812C0.937515 11.0225 0.727498 10.8125 0.468777 10.8125C0.210055 10.8125 0 11.0225 0 11.2812V15.0312C0 15.29 0.210016 15.5 0.468738 15.5H14.5312C14.79 15.5 15 15.2899 15 15.0312V11.2812C15 11.0225 14.79 10.8125 14.5312 10.8125Z" fill="#007BFF"/>
                            <path d="M7.1575 11.6126C7.33985 11.7931 7.64501 11.795 7.82733 11.6126L11.1081 8.37826C11.2933 8.19498 11.2928 7.89827 11.1081 7.71545C10.9234 7.53216 10.6234 7.53216 10.4387 7.71545L7.96608 10.153V0.968738C7.96608 0.709977 7.75419 0.5 7.49263 0.5C7.23106 0.5 7.01917 0.710016 7.01917 0.968738V10.153L4.54651 7.71545C4.36136 7.53216 4.06184 7.53216 3.87715 7.71545C3.69199 7.89873 3.69199 8.19544 3.87715 8.37826L7.1575 11.6126Z" fill="#007BFF"/>
                        </svg>
                    </button>
                </div>
            </div>
            {showExpanded()}
        </div>
    </>);
}